---
title: "Flacc m6a - Differr + Yanocomp"
---
```{r}
library(dplyr)
library(ggplot2)
library(data.table)
library(clusterProfiler)
library(org.At.tair.db)
library(readr)
library(GenomicFeatures)
library(purrr)
library(reshape2)
library(Biostrings)
library(eulerr)
library(rtracklayer)
library(valr)
```
Load genome and annotation
```{r}
At.genome <- Rsamtools::FaFile("/Volumes/cluster/ggs_lab/mtparker/papers/efs/efs_nanopore/annotation/GCA_902460285.1_Arabidopsis_thaliana_Ler_genomic.fa")
# Load TxDb
txdb <- makeTxDbFromGFF("/Volumes/cluster/ggs_lab/mtparker/papers/efs/efs_nanopore/annotation/araport11_ler.gtf")
```

Colour palette
```{r colour bar, echo=FALSE, fig.height=2, fig.width=13}
palette <- c(
 # Writers
  "MTA"     = "#004488",
  "VIR"  = "#009988",
  "FIP37"   = "#0077BB",
  "hiz2-4" = "#AA4499",
  "hiz2-2"    = "#CCAA22",
  "HAKAI" = "#556B2F",
  #Readers
  "ECT"     = "#EE7733",
  "CPSF30"  = "#DD3377",
  #Other
  "U2B"     = "#CC3311",
  "Col-0"    = "#888888"
)
barplot(rep(1, 10), col = palette, names.arg = names(palette), yaxt = "n")
```
Get the diff err stats for hiz2-4 vs col0
olumns of bed file are:

    chrom, start, end, name
    score: -log10 of the FDR, rounded to nearest whole number
    strand
    odds ratio: the change in the ratio of matches to mismatches in the wild type compared to the mutant with low modifications. An odds ratio > 0 indicates more modifications in the WT.
    G statistic for the comparison of pooled WT and mutant samples.
    -log10 P value for the comparison of pooled WT and mutant samples.
    -log10 FDR for the comparison of pooled WT and mutant samples.
    G statistic for the homogeneity test of mutant replicates.
    -log10 P value for the homogeneity test of mutant replicates.
    G statistic for the homogeneity test of wild type replicates.
    -log10 P value for the homogeneity test of wild type replicates.

```{r}
efs_diff_err <- fread("/Volumes/cluster/ggs_lab/mtparker/papers/efs/efs_nanopore/pipeline/differr/efs_thresholded.bed")
colnames(efs_diff_err) <- c("chrom", "start", "end", "name", "score", "strand", "odds", "G", "P", "FDR", "g_hom", "P_hom", "g_hom_c", "P_hom_c")
head(efs_diff_err)
```
Get a histogram of fold changes of errors/matches
```{r}
histogram <- ggplot(data = efs_diff_err, aes(x = odds)) +
  scale_x_continuous(limits = c(-10,10), expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_area(aes(x=X,y=Y),data=data.frame(X=c(-10,0), Y = 100),alpha=0.3,fill="#F0E442")+
  geom_area(aes(x=X,y=Y),data=data.frame(X=c(0,10), Y = 100),alpha=0.3,fill="#0072B2")+
  geom_histogram(fill = "#556B2F", colour="white", bins=40)+
  geom_vline(xintercept = 0, linetype = "dashed", color = "#252525") +
  annotate("text", x = -3.5, y = 90, label = paste("n=", sum(efs_diff_err$odds < 0)), size = 5) +
  annotate("text", x = 3.9, y = 90, label = paste("n=", sum(efs_diff_err$odds > 0)), hjust = 1, size = 5) +
  theme_minimal(base_size=15)+
  xlab("Fold change of errors/matches (log2 scale)")+
  ylab("Error sites (frequency)")

histogram
```
```{r}
ggsave(
  filename = "../../Figures/figure_3/efs_col0_diff_err_histogram.pdf",
  plot = histogram,
  width = 6, height = 5, units = "in" 
)
ggsave(
  filename = "../../Figures/figure_3/efs_col0_diff_histogram.png",
  plot = histogram,
  width = 6, height = 5, units = "in" 
)
```

Where are the sites located?
```{r}
# List of positions
positions <- tibble(
  efs_diff_err[,1:6]
)
positions <- positions %>%
  mutate(start = as.numeric(start))
head(positions)
```


```{r}
# Extract UTRs
five_utrs <- fiveUTRsByTranscript(txdb, use.names=TRUE)
three_utrs <- threeUTRsByTranscript(txdb, use.names=TRUE)

# Flatten into GRanges
five_utrs_flat <- unlist(five_utrs, use.names=FALSE)
three_utrs_flat <- unlist(three_utrs, use.names=FALSE)

five_utrs_flat$region_type <- "5UTR"
three_utrs_flat$region_type <- "3UTR"

# Combine 5' and 3' UTRs into one GRanges
utr_regions <- c(five_utrs_flat, three_utrs_flat)
```


```{r}
# Make GRanges from your table
data_gr <- GRanges(
  seqnames = positions$chrom,
  ranges = IRanges(start = positions$start, end = positions$end),
  strand = positions$strand,
  transcript_id = positions$name
)

# Find overlaps
hits <- findOverlaps(data_gr, utr_regions, ignore.strand=FALSE)

# Create a vector of UTR annotations
utr_annotation <- rep(NA_character_, length(data_gr))
utr_annotation[queryHits(hits)] <- mcols(utr_regions)$region_type[subjectHits(hits)]

# Add to your table
positions_annotated <- positions %>%
  mutate(UTR_type = utr_annotation)

head(positions_annotated)
```
```{r}
table(positions_annotated$UTR_type)
```

Distance from nearest vir
Load in the vir differr data
```{r}
vir1_diff_err <- fread("/Volumes/cluster/ggs_lab/mtparker/papers/flacc/flacc_nanopore/pipeline/differr/vir1_vs_VIRc.bed")
colnames(vir1_diff_err) <- c("chrom", "start", "end", "name", "score", "strand", "odds", "G", "P", "FDR", "g_hom", "P_hom", "g_hom_c", "P_hom_c")
head(vir1_diff_err)
```




